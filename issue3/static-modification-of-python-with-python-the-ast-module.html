
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>AST 模块：用 Python 修改 Python 代码 &mdash; PyCoder&#39;s Weelky CN</title>
    
    <link rel="stylesheet" href="../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <style type="text/css">.reference em {font-style: normal; } a tt {font-size: 1.2em; font-weight: normal; }</style>
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="PyCoder&#39;s Weelky CN" href="../index.html" />
    <link rel="up" title="issue 3: Code Hard" href="index.html" />
    <link rel="next" title="Python 的闭包和装饰器" href="python-closures-and-decorators.html" />
    <link rel="prev" title="Python应用程序包" href="python-application-package.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../index.html">PyCoder&#39;s Weelky CN</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">issue 3: Code Hard</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="ast-python-python">
<span id="toctree-directive"></span><h1>AST 模块：用 Python 修改 Python 代码<a class="headerlink" href="#ast-python-python" title="Permalink to this headline">¶</a></h1>
<p>原文地址： <a class="reference external" href="http://blueprintforge.com/blog/2012/02/27/static-modification-of-python-with-python-the-ast-module/">http://blueprintforge.com/blog/2012/02/27/static-modification-of-python-with-python-the-ast-module/</a></p>
<p>翻译： <a class="reference external" href="http://upsuper.org/">Upsuper</a></p>
<p>修改代码在有时会变的十分有用，比如在进行测试和分析的时候。在这篇文章中，我们将看到如何使用 <tt class="docutils literal"><span class="pre">ast</span></tt> 模块对 Python 代码进行修改，同时还将看到一些使用了这个技术的工具。</p>
<div class="section" id="cpython">
<h2>CPython 的编译过程<a class="headerlink" href="#cpython" title="Permalink to this headline">¶</a></h2>
<img alt="../_images/pep339.png" class="align-left" src="../_images/pep339.png" />
<p>在开始之前，我们应该先看看 CPython 的编译过程，这个过程在 <a class="reference external" href="http://www.python.org/dev/peps/pep-0339/">PEP 339</a> 中有详细的描述。</p>
<p>当然，在读这篇文章的时候，你并不需要对这个步骤有很深入的理解，不过这可以帮助你对整个过程有一个大体的了解。</p>
<p>首先，编译器会根据源代码生成一棵语法分析树 (Parse Tree)，随后，再根据语法分析树建立抽象语法树 (AST, Abstract Syntax Tree)。从 AST 中可以生成出控制流图 (CFG, Control Flow Graph)，最后再将控制流图编译为代码对象 (Code Object)。</p>
<p>图中标蓝的部分就是 AST 这一步，也就是我们今天所关注的部分。Python 从 2.6 开始就提供了现在这样的 <tt class="docutils literal"><span class="pre">ast</span></tt> 模块，它提供了一种访问和修改 AST 的简单方式。</p>
<p>通过这个，我们可以从 AST 中生成代码对象，也可以出于某些原因，根据修改过的 AST 重新生成源代码。</p>
</div>
<div class="section" id="ast">
<h2>创建 AST<a class="headerlink" href="#ast" title="Permalink to this headline">¶</a></h2>
<p>先来写一点简单的代码，我们写一个叫做 <tt class="docutils literal"><span class="pre">add</span></tt> 的函数，然后观察它所生成的 AST。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ast</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">def add(arg1, arg2):</span>
<span class="gp">... </span><span class="s">    return arg1 + arg2</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr_ast</span>
<span class="go">&lt;_ast.Module object at 0x10a7a09d0&gt;</span>
</pre></div>
</div>
<p>现在我们已经生成了一个 <tt class="docutils literal"><span class="pre">ast.Module</span></tt> 对象，我们来看看它的内容：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">expr_ast</span><span class="p">)</span>
<span class="go">&quot;Module(</span>
<span class="go">    body=[</span>
<span class="go">        FunctionDef(</span>
<span class="go">            name=&#39;add&#39;, args=arguments(</span>
<span class="go">                args=[</span>
<span class="go">                    Name(id=&#39;arg1&#39;, ctx=Param()),</span>
<span class="go">                    Name(id=&#39;arg2&#39;, ctx=Param())</span>
<span class="go">                    ],</span>
<span class="go">                    vararg=None,</span>
<span class="go">                    kwarg=None,</span>
<span class="go">                    defaults=[]),</span>
<span class="go">            body=[</span>
<span class="go">                Return(</span>
<span class="go">                    value=BinOp(</span>
<span class="go">                        left=Name(id=&#39;arg1&#39;, ctx=Load()),</span>
<span class="go">                        op=Add(),</span>
<span class="go">                        right=Name(id=&#39;arg2&#39;, ctx=Load())))</span>
<span class="go">                ],</span>
<span class="go">            decorator_list=[])</span>
<span class="go">    ])&quot;</span>
</pre></div>
</div>
<p>正如我们所见， <tt class="docutils literal"><span class="pre">Module</span></tt> 是父节点，它的 <tt class="docutils literal"><span class="pre">body</span></tt> 中包含了一个函数定义的元素，这个函数定义包含了函数名、参数列表和函数体。函数体又包含了一个单独的 <tt class="docutils literal"><span class="pre">Return</span></tt> 节点，节点中含有一个 <tt class="docutils literal"><span class="pre">Add</span></tt> 运算。</p>
</div>
<div class="section" id="id1">
<h2>修改 AST<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>我们如何修改这棵树以改变代码的作用呢？为了说明这个问题，我们来做点也许你永远也不会在你自己代码中做的疯狂的事情吧。我们将遍历这棵树，并且将 <tt class="docutils literal"><span class="pre">Add</span></tt> 运算修改为 <tt class="docutils literal"><span class="pre">Mult</span></tt> 运算。看，我说过这很疯狂吧！</p>
<p>我们要先建立一个 <tt class="docutils literal"><span class="pre">NodeTransformer</span></tt> 变换器的子类，并且定义 <tt class="docutils literal"><span class="pre">visit_BinOp</span></tt> 方法。每当这个变换器访问到一个二元运算符节点时，就会调用这个方法。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CrazyTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">visit_BinOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Mult</span><span class="p">()</span>
        <span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
<p>现在我们已经定义好了我们这个奇怪的变换器，让我们看看将它应用于我们开始时写的那些代码会怎么样：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">transformer</span> <span class="o">=</span> <span class="n">CrazyTransformer</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">expr_ast</span><span class="p">)</span>
<span class="go">{</span>
<span class="go">    &#39;op&#39;: &lt;_ast.Add object at 0x10a8321d0&gt;,</span>
<span class="go">    &#39;right&#39;: &lt;_ast.Name object at 0x10a839390&gt;,</span>
<span class="go">    &#39;lineno&#39;: 3, &#39;col_offset&#39;: 8,</span>
<span class="go">    &#39;left&#39;: &lt;_ast.Name object at 0x10a839350&gt;}</span>
<span class="go">{</span>
<span class="go">    &#39;op&#39;: &lt;_ast.Mult object at 0x10a839510&gt;,</span>
<span class="go">    &#39;right&#39;: &lt;_ast.Name object at 0x10a839390&gt;,</span>
<span class="go">    &#39;lineno&#39;: 3, &#39;col_offset&#39;: 8,</span>
<span class="go">    &#39;left&#39;: &lt;_ast.Name object at 0x10a839350&gt;}</span>
</pre></div>
</div>
<p>你可以从输出的结果对比发现， <tt class="docutils literal"><span class="pre">Add</span></tt> 节点已经被替换成了一个 <tt class="docutils literal"><span class="pre">Mult</span></tt> 。我们有许多方法没有提到，比如访问子节点，不过这个例子已经足以刻画出它的基本原理。</p>
</div>
<div class="section" id="id2">
<h2>编译和执行修改后的 AST<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>我们在最初的代码后面加上一个调用，比如：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>让我们看看这些代码是如何运行的：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">unmodified</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">exec</span> <span class="nb">compile</span><span class="p">(</span><span class="n">unmodified</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="go">9</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transformer</span> <span class="o">=</span> <span class="n">CrazyTransformer</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">modified</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">unmodified</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">exec</span> <span class="nb">compile</span><span class="p">(</span><span class="n">modified</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="go">20</span>
</pre></div>
</div>
<p>我们可以看到，未修改的和修改后的 AST 所编译出的代码，一个输出了9，一个输出了20。</p>
</div>
<div class="section" id="id3">
<h2>重新翻译回源代码<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>最后，我们可以用 <tt class="docutils literal"><span class="pre">unparse</span></tt> 模块将修改后的代码转换回对应的源代码， <tt class="docutils literal"><span class="pre">unparse</span></tt> 模块可以在 <a class="reference external" href="http://svn.python.org/projects/python/trunk/Demo/parser/unparse.py">这里</a> 找到。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">unparse</span><span class="o">.</span><span class="n">Unparser</span><span class="p">(</span><span class="n">modified</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="go">def add(arg1, arg2):</span>
<span class="go">    return (arg1 * arg2)</span>
<span class="go">print add(4, 5)</span>
</pre></div>
</div>
<p>正如我们所看到的， <tt class="docutils literal"><span class="pre">*</span></tt> 运算符取代了 <tt class="docutils literal"><span class="pre">+</span></tt> 。在这个反解析工具对于理解你的 AST 变换器如何修改代码很有帮助。</p>
</div>
<div class="section" id="id5">
<h2>实践应用<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>显然，我们上面的例子在实际应用中几乎没有意义。然而静态分析和修改代码却是十分有用的。</p>
<p>比如你可以为测试程序而注入一些代码。你可以看看 <a class="reference external" href="http://www.tudou.com/programs/view/5IHp-wxyt3c/">这篇 PyCon 演讲</a> ( <a class="reference external" href="http://blip.tv/pycon-us-videos-2009-2010-2011/pycon-2011-what-would-you-do-with-an-ast-4898264">origin</a> ) 以理解如何使用一个节点转换器注入指令代码来测试程序。</p>
<p>除此之外， <a class="reference external" href="http://pythoscope.org/">Pythonscope 项目</a> 也使用了 AST 访问器 (visitor) 来处理源代码并根据函数签名生成测试。</p>
<p>还有像 pylint 这样的项目使用 AST 步移法 (walking method) 来分析源代码。在 pylint 中，Logilab 还建立了一个模块专门用于：</p>
<blockquote>
<div>&#8220;提供一个通用的 Python 源代码基本表示方式以为如 pychecker、pyreverse 或 pylint 等项目的开发提供方便。&#8221;</div></blockquote>
<p>你可以在 <a class="reference external" href="http://www.logilab.org/project/logilab-astng">这里</a> 看到更多关于这个项目的信息。</p>
</div>
<div class="section" id="id7">
<h2>引用<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>Matthew J Desmarais 的 <a class="reference external" href="http://www.tudou.com/programs/view/5IHp-wxyt3c/">这篇 PyCon 演讲</a> ( <a class="reference external" href="http://blip.tv/pycon-us-videos-2009-2010-2011/pycon-2011-what-would-you-do-with-an-ast-4898264">origin</a> ) 以及 Eli Bendersky 的 <a class="reference external" href="http://eli.thegreenplace.net/2009/11/28/python-internals-working-with-python-asts/">这篇博客</a> 对于本文的帮助是无可估量的。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">AST 模块：用 Python 修改 Python 代码</a><ul>
<li><a class="reference internal" href="#cpython">CPython 的编译过程</a></li>
<li><a class="reference internal" href="#ast">创建 AST</a></li>
<li><a class="reference internal" href="#id1">修改 AST</a></li>
<li><a class="reference internal" href="#id2">编译和执行修改后的 AST</a></li>
<li><a class="reference internal" href="#id3">重新翻译回源代码</a></li>
<li><a class="reference internal" href="#id5">实践应用</a></li>
<li><a class="reference internal" href="#id7">引用</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/issue3/static-modification-of-python-with-python-the-ast-module.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../index.html">PyCoder&#39;s Weelky CN</a> &raquo;</li>
          <li><a href="index.html" >issue 3: Code Hard</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, PyCodersCN.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>